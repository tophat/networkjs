version: 2.1

docker_defaults: &docker_defaults
  docker:
    - image: circleci/node:8.14.0

commands:
  restore_cache:
    description: "Prepares dependencies"
    steps:
      - checkout:
          path: ~/repo
      - restore_cache:
          name: Restore node_modules cache
          key: networkjs-{{ .Branch }}-{{ checksum "yarn.lock" }}{{ .Environment.CACHE_KEY }}
  save_cache:
    description: "Saves dependencies"
    steps:
      - save_cache:
          name: Save node_modules cache
          key: networkjs-{{ .Branch }}-{{ checksum "yarn.lock" }}{{ .Environment.CACHE_KEY }}
          paths:
            - node_modules/

jobs:
  install:
    <<: *docker_defaults
    working_directory: ~/project
    steps:
      - run: yarn install
      - save_cache
  build:
    <<: *docker_defaults
    working_directory: ~/project
    steps:
      - restore_cache
      - run: yarn build
  test:
    <<: *docker_defaults
    working_directory: ~/project
    steps:
      - restore_cache
      - attach_workspace:
          at: ~/project
      - run: yarn test
  lint:
    <<: *docker_defaults
    working_directory: ~/project
    steps:
      - restore_cache
      - run: yarn lint

workflows:
  version: 2
  test_lint_build:
      jobs:
          - install
          - lint:
              - requires:
                  - install
          - test:
              - requires:
                  - install
          - build:
              - requires:
                  - install
experimental:
  notify:
    branches:
      only:
        - master
